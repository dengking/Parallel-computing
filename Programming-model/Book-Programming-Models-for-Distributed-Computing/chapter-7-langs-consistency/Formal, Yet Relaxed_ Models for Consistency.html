<!DOCTYPE html>
<!-- saved from url=(0058)http://dist-prog-book.com/chapter/7/langs-consistency.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Formal, Yet Relaxed: Models for Consistency</title>
  <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

  <!-- jquery js -->
  <script src="./Formal, Yet Relaxed_ Models for Consistency_files/jquery-1.11.0.min.js.下载" type="text/javascript"></script>

  <!-- retina js -->
  <script src="./Formal, Yet Relaxed_ Models for Consistency_files/retina.js.下载" type="text/javascript"></script>

  <!-- Bootstrap JS and CSS -->
  <!-- <link rel="stylesheet" href="/resources/css/bootstrap.min.css" type="text/css" media="screen, print"/> -->
  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v0.3.0/dist/bootstrap-toc.min.css">
  <script src="./Formal, Yet Relaxed_ Models for Consistency_files/bootstrap.min.js.下载" type="text/javascript"></script>
  <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v0.3.0/dist/bootstrap-toc.min.js"></script>

  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/fira.css">
  <link href="./Formal, Yet Relaxed_ Models for Consistency_files/css" rel="stylesheet">
  <link href="./Formal, Yet Relaxed_ Models for Consistency_files/css(1)" rel="stylesheet">

  <!-- Fonts -->
  <link href="./Formal, Yet Relaxed_ Models for Consistency_files/css(2)" rel="stylesheet">
  <link href="./Formal, Yet Relaxed_ Models for Consistency_files/css(3)" rel="stylesheet" type="text/css">
  <link href="./Formal, Yet Relaxed_ Models for Consistency_files/css(4)" rel="stylesheet" type="text/css">

  <!-- MathJax -->
  <script src="./Formal, Yet Relaxed_ Models for Consistency_files/MathJax.js.下载" id=""></script>

  <!-- <link rel="stylesheet" href="/resources/css/tufte.css"/> -->
  <!-- <link rel="stylesheet" href="/resources/css/custom.css"/> -->
  <!-- <link rel="stylesheet" href="/resources/css/github.css"/> -->

  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/latex.css">
  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/entypo.css" type="text/css">
  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/prettify.css" type="text/css">
  <!-- <link rel="stylesheet" href="/resources/css/main.css" type="text/css" /> -->
  <link rel="stylesheet" href="./Formal, Yet Relaxed_ Models for Consistency_files/blog.css" type="text/css">

  <!-- Custom javascript -->
  <script src="./Formal, Yet Relaxed_ Models for Consistency_files/main.js.下载" type="text/javascript"></script>

  <!-- <link rel="canonical" href="http://yourdomain.com/chapter/7/langs-consistency.html"> -->
  <link rel="alternate" type="application/rss+xml" title="Programming Models for Distributed Computing" href="http://yourdomain.com/feed.xml">
<style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style></head>

<body data-spy="scroll" data-target="#toc"><div id="MathJax_Message" style="display: none;"></div>
  <div class="topbar">
    <div class="container">
      <div class="row">
        <div class="col-sm-1"></div>
        <div class="col-sm-5">
          <div class="logo-wrap">
            <a href="http://dist-prog-book.com/">
              <svg class="logo" width="100" height="100">
                <circle cx="50" cy="50" r="35" stroke-width="6" stroke="#fff" fill="#b3c7cf"></circle>
                <circle cx="50" cy="50" r="20" fill="#92adb9"></circle>
                <circle cx="50" cy="50" r="14" fill="#7499AA"></circle>
              </svg>
              <div class="book-title">
                <div class="prog-mod">Programming Models for</div>
                <div class="dist-comp">Distributed Computing</div>
              </div>
            </a>
          </div>
        </div>
        <div class="col-sm-5 visible-md visible-lg">
          <div class="navbar-wrap">
            <ul class="navbar">
              <li><a href="http://dist-prog-book.com/index.html">Intro</a></li>
<li><a href="http://dist-prog-book.com/chapter">Chapters</a></li>
<li><a href="http://dist-prog-book.com/about.html">About</a></li>
            </ul>
          </div>
        </div>
        <div class="col-sm-5 visible-sm visible-xs">
          <div id="burger" data-toggle="collapse" data-target="#navbar-responsive-wrap">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="navbar-responsive-wrap navbar-static-top navbar-collapse collapse" id="navbar-responsive-wrap">
            <ul class="navbar-responsive">
              <li><a href="http://dist-prog-book.com/index.html">Intro</a></li>
<li><a href="http://dist-prog-book.com/chapter">Chapters</a></li>
<li><a href="http://dist-prog-book.com/about.html">About</a></li>
            </ul>
          </div>
        </div>
        <div class="col-sm-1">
        </div>
      </div>
    </div>
  </div>

  <div class="container blog">
    <div class="row">
      <div class="col-sm-2"></div>
      <div class="col-sm-6">
        
        <div class="category"></div>
        <h1 class="page-title">Formal, Yet Relaxed: Models for Consistency</h1>
        <div class="author">By James Larisch</div>
        <div class="subtitle">
          
            <span class="minutes">(49 min read)</span>
          
        </div>
        <div class="dash">—</div>
        <!-- <article> -->

  <!-- <h1 class="post-title">Formal, Yet Relaxed: Models for Consistency</h1> -->
  <!-- <div class="author">By James Larisch</div> -->

    <h2 id="whats-the-problem">What’s the problem?</h2>
<p>In many ways, web developers deal with distributed systems problems every day: your client and your server are in two different geographical locations, and thus, some coordination between computers is required.</p>

<p>As Aviral discussed in the previous section, many computer scientists have done a lot of thinking about the nature of distributed systems problems. As such, we realize that it’s impossible to completely emulate the behavior of a single computational machine using multiple machines. For example, the network is simply not as reliable as, say, memory - and waiting for responses can result in untimeliness for the application’s user base. After discussing the Consistency/Availability/Partition-tolerance theorem, Section 6 discussed how we can drill down into the CAP pyramid and choose the necessary and unnecessary properties of our systems. As stated, we can’t perfectly emulate a single computer using multiple machines, but once we accept that fact and learn to work with it, there are plenty of things we <em>can</em> do!</p>

<h2 id="the-shopping-cart">The Shopping Cart</h2>
<p>Let’s bring all this theorem talk back to reality. Let’s say you’re working at a new e-commerce startup, and you’d like to revolutionize the electronic shopping cart. You’d like to give the customer the ability to do the following:</p>

<ol>
  <li>Log in to the site and add a candle to the cart while traveling in Beijing.</li>
  <li>Take a HyperLoop (3 hours) from Beijing to Los Angeles.</li>
  <li>Log back in, remove the candle from the cart, and add a skateboard.</li>
  <li>Take another HyperLoop train from Los Angeles to Paris (5 hours).</li>
  <li>Log back into the site, add another skateboard, and checkout.</li>
</ol>

<p>Let’s assume you have a server in every single country, and customers connect to the geographically closest server.</p>

<p>How can we ensure that the client sees the same cart at every point in her trip?</p>

<p>If you only had one user of your website, this wouldn’t be too hard. You could manually, constantly modify and check on all of your servers and personally make sure the state of the customer’s shopping cart is consistent across every single server. But what happens when you have millions of customers and thus millions of shopping carts? That would be impossible to keep track of personally. Luckily, you’re a programmer - this can be automated! You simply need to make sure that all of your computers stay in-sync, so if the customer checks her cart in Beijing, then in Paris, she sees the same thing.</p>

<p>But as Section 6 has already explained, this is not so trivial. Messages between your servers in Beijing and Paris could be dropped, corrupted, reordered, duplicated, or delayed. Servers can crash. Sharks can cut the network cables between countries. Since you have no guarantees about when you’ll be able to synchronize state between two servers, it’s possible that the customer could see two different cart-states depending on which country she’s in (which server she asks).</p>

<p>It’s possible to implement “consensus” protocols such as Paxos and Raft that provide coordination between your machines. When more failures than the system can tolerate occur, such as a network shark-attack, the protocol detects a lack of consistency and becomes <em>unavailable</em> - at least until it is consistent once more. For applications in which inconsistent state is dangerous, this is appropriate. For a shopping cart, this seems like overkill. If our shopping cart system experienced a failure and became unavailable, users would not be able to add or remove things from the cart. They also couldn’t check out. This means our startup would lose money! Perhaps it’s not so important that our clients’ shopping carts be completely synchronized across the entire world at all times. After all, how often are people going to be doing such wanderlust shopping?</p>

<p>This is an important moment. By thinking about our specific problem, we’ve realized a compromise we’re willing to make: our users always need to be able to add things, remove things, and checkout. In other words, our service needs to be as <em>available</em> as possible. Servers don’t necessarily need to agree all the time. We’d like them to, but the system shouldn’t shut down if they don’t. We’ll find a way to deal with it.</p>

<p>Turns out there’s a company out there called Amazon.com - and they’ve been having a similar problem. Amazon sells things on their website too, and users can add and remove things from their cart. Amazon has lots of servers spread out across the world. They also have quite a few customers. They need to ensure their customers’ carts are robust: if/when servers fail or lose communication with one another, a “best-effort” should be made to display the customer’s cart. Amazon acknowledges that failure, latency, or HyperLoop-traveling users can cause inconsistent cart data, depending on which server you ask. How does Amazon resolve these issues?</p>

<h2 id="dynamo">Dynamo</h2>

<p>Amazon built DynamoDB <a href="http://dist-prog-book.com/chapter/7/langs-consistency.html#Dynamo">(DeCandia et al., 2007)</a>, which is basically a big distributed hash table. I won’t go into the details of DHTs, but let’s imagine Dynamo as a hashmap, replicated across multiple servers. A user’s cart is stored as a value under the user’s username as the key. (<code class="highlighter-rouge"><span class="p">{</span><span class="err">'james':</span><span class="w"> </span><span class="err">['candle',</span><span class="w"> </span><span class="err">'skateboard']</span><span class="p">}</span></code>) When a user adds a new item to her cart, either the entire cart or this update is sent to every other server (or, replica). Since, say, a network cable can fail, one replica may have <em>inconsistent state</em>: a different view of the universe (a shopping cart, in this case) than every other server.</p>

<p>Dynamo has a rather unique way of dealing with these types of inconsistencies. Since Dynamo always wants to be available for both writes and reads (add/removes, viewing/checkouts, resp) it must have a way of combining inconsistent data. Dynamo chooses to perform this resolution at read time. When a client performs a <code class="highlighter-rouge">get()</code> on the user’s cart, Dynamo will query multiple servers for the cart data, for redunancy’s sake. Dynamo recognizes the inconsistent state and will take the multiple conflicting carts and push them up to the application! Huh? I thought Dynamo resolves this for the programmer!? Actually, Dynamo is a rather unopinionated key-value store. It detects inconsistencies in the data - but once it does, it simply tells the application (in this case the application is the shopping cart code) that there are some conflicts. The application (shopping cart, in this case) is free to resolve these inconsistencies as it pleases.</p>

<p>How should Amazon’s shopping cart procede with resolution? It may be fed two cart states like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">James's Cart V1  |  James's Cart V2
-----------------------------------
Red Candle       |  Red Candle
Blue Skateboard  |  Green Umbrella
</code></pre>
</div>

<p>Amazon doesn’t want to accidently <em>remove</em> anything from your cart, so it errs on the side of inclusion. If given this particular conflict, you may see:</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">James's Cart
------------
Red Candle
Blue Skateboard
Green Umbrella
</code></pre>
</div>

<p>Dynamo has multiple machines in charge of storing the contents of your cart. When you add something to your cart, Dynamo specifies a minimum number of nodes that must receive the new data before the write is considered complete. The same thing goes for reading the contents of your cart: Dynamo requires a minimum number of healthy, responsive nodes to return cart data before relaying this data to the user. Nodes periodically gossip their local state to their neighbors to ensure that any updates, which occurred while the node may have been offline, are eventually delivered. However, Dynamo sends updates to your carts asynchronously to all replicas. This means when you read the contents of your cart, it’s possible to receive different results from different replicas.</p>

<h2 id="dynamo-simplification">Dynamo Simplification</h2>

<p>What do we love about Dynamo? It’s a highly available key-value store. It replicates data well, and according to the paper, has high uptime and low latency. We love that it’s <em>eventually consistent</em>. Nodes are constantly gossiping and <code class="highlighter-rouge">put</code>s are asynchronously propagated, so given enough time (and assuming failures are resolved), nodes’ states will eventually converge. However, this property is <em>weak</em>. It’s weak because when failures &amp; conflicts occur, and <a href="https://www.youtube.com/watch?v=JG2ESDGwHHY">and they will occur</a>, it’s up to the application developer to figure out how to handle it. Given a conflict, there isn’t a one-size-fits-all solution for resolving them. In the case of the shopping cart, it’s relatively trivial: our resolution strategy errs on the side of inclusion. But as a programmer, every time you use DynamoDB for a different purpose you need to consider your resolution strategy. The database doesn’t provide a general solution.</p>

<p>Instead of constructing an all-purpose database and forcing the burden of resolution on programmers, what if we constructed multi-purpose (read: multi, not <em>all</em>) data structures that required no manual resolution? These data structures would resolve conflicts inherently, themselves, and depending on your application you could choose which data structure works best for you.</p>

<p>Let’s try this transfiguration on the shopping cart. Let’s strip it down: how does Amazon handle resolution, really? It treats shopping cart versions as sets of items. In order to perform resolution, Amazon unions the two sets.</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="p">{</span><span class="w"> </span><span class="err">Red</span><span class="w"> </span><span class="err">Candle,</span><span class="w"> </span><span class="err">Blue</span><span class="w"> </span><span class="err">Skateboard</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="err">U</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">Red</span><span class="w"> </span><span class="err">Candle,</span><span class="w"> </span><span class="err">Green</span><span class="w"> </span><span class="err">Umbrella</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">Red</span><span class="w"> </span><span class="err">Candle,</span><span class="w"> </span><span class="err">Blue</span><span class="w"> </span><span class="err">Skateboard,</span><span class="w"> </span><span class="err">Green</span><span class="w"> </span><span class="err">Umbrella</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>Using this knowledge, let’s try to construct our own shopping cart that automatically resolves conflicts.</p>

<p>(Unfortunately Amazon has a leg up on our startup. Their programmers have figured out a way to add multiple instances of a single item into the cart. Users on our website can only add one “Red Candle”” to their shopping cart. This is due to a fundamental limitation in the type of CRDT I chose to exemplify. It’s quite possible to have a fully functional cart. Take a look at OR-Sets. If these sentences made no sense to you, don’t worry!)</p>

<h3 id="example">Example</h3>

<p>Let’s take a look at the following JavaScript. For simplicity’s sake, let’s pretend users can only add things to their shopping cart.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="kr">class</span> <span class="nx">Cart</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">peers</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mySocket</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peers</span> <span class="o">=</span> <span class="nx">peers</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">addItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">synchronize</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">peers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">peer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">peer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">receiveState</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clientAddition</span> <span class="o">=</span> <span class="nx">Interface</span><span class="p">.</span><span class="nx">nonBlockingReceiveInput</span><span class="p">();</span> <span class="c1">// invented</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clientAddition</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addItem</span><span class="p">(</span><span class="nx">clientAddition</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">receivedState</span> <span class="o">=</span> <span class="nx">mySocket</span><span class="p">.</span><span class="nx">nonBlockingRead</span><span class="p">();</span> <span class="c1">// invented</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">receivedState</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">receiveState</span><span class="p">(</span><span class="nx">receivedState</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">synchronize</span><span class="p">();</span>
    <span class="nx">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="nx">run</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// theoretical usage</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UDPSocket</span><span class="p">();</span> <span class="c1">// invented</span>
<span class="kd">var</span> <span class="nx">cart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cart</span><span class="p">(</span><span class="nx">peerSockets</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span> <span class="c1">// peerSockets is an array of UDP sockets</span>
<span class="nx">cart</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
<span class="nx">cart</span><span class="p">.</span><span class="nx">items</span> <span class="c1">// the cart's items</span>
</code></pre>
</div>

<p>Here is an (almost) fully functional shopping cart program. You can imagine this code running across multiple nodes scattered over the world. The meat of the program lies in the <code class="highlighter-rouge">run()</code> method. Let’s walk through that:</p>

<ol>
  <li>Program receives an addition to the cart from the user.</li>
  <li>Program adds that item to the current local state if it exists.</li>
  <li>Program checks its UDP socket for any messages.</li>
  <li>If it received one, it’s means another instance of this program has sent us its state. What is state in this case? Simply a set of cart items. Let’s handle this set of items by unioning it with our current set.</li>
  <li>Synchronize our current state by sending our state to every peer that we know about.</li>
  <li>Sleep for 10 seconds.</li>
  <li>Repeat!</li>
</ol>

<p>Hopefully it’s clear that if a client adds an item to her cart in Beijing and then 10 seconds later checks her cart in Paris, she should see the same thing. Well, not exactly - remember, the network is unreliable, and Beijing’s <code class="highlighter-rouge">synchronize</code> messages might have been dropped, delayed, or reordered. But no worries! Beijing is <code class="highlighter-rouge">synchronizing</code> again in another 10 seconds. This should remind you of Dynamo’s gossip and propagation: nodes are constantly attempting to converge.</p>

<p>Both systems are eventually consistent - the difference here is our Javascript shopping cart displays <em>strong</em> eventual consistency. It’s strong because the resolution strategy is built in. In order words, the carts know <em>how to handle inconsistency</em>, rather than simply asking the programmer what to do. When a node transmits its state to another node, there’s absolutely no question about how to integrate that state into the current one. There’s no conflict. This is certainly an improvement from Dynamo.</p>

<h2 id="the-intern-a-lack-of-guarantees">The Intern: A Lack of Guarantees</h2>

<p>Unfortunately Jerry, the intern, has found your code. He’d like to add <code class="highlighter-rouge">remove</code> functionality to the cart. So he makes the following changes:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="kr">class</span> <span class="nx">Cart</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">peers</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mySocket</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">peers</span> <span class="o">=</span> <span class="nx">peers</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">addItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">synchronize</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">peers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">peer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">peer</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">receiveState</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// JERRY WAS HERE</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">intersection</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
    <span class="c1">// END JERRY WAS HERE</span>
  <span class="p">}</span>

  <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clientAddition</span> <span class="o">=</span> <span class="nx">Interface</span><span class="p">.</span><span class="nx">nonBlockingReceiveInput</span><span class="p">();</span> <span class="c1">// invented</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clientAddition</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">addItem</span><span class="p">(</span><span class="nx">clientAddition</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// JERRY WAS HERE</span>
    <span class="kd">var</span> <span class="nx">clientDeletion</span> <span class="o">=</span> <span class="nx">Interface</span><span class="p">.</span><span class="nx">nonBlockingReceiveInput</span><span class="p">()</span><span class="err">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clientDeletion</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">clientDeletion</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// END JERRY WAS HERE</span>

    <span class="kd">var</span> <span class="nx">receivedState</span> <span class="o">=</span> <span class="nx">mySocket</span><span class="p">.</span><span class="nx">nonBlockingRead</span><span class="p">();</span> <span class="c1">// invented</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">receivedState</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">receiveState</span><span class="p">(</span><span class="nx">receivedState</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">synchronize</span><span class="p">();</span>
    <span class="nx">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="nx">run</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// theoretical usage</span>

<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UDPSocket</span><span class="p">();</span> <span class="c1">// invented</span>
<span class="kd">var</span> <span class="nx">cart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cart</span><span class="p">(</span><span class="nx">peerSockets</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span> <span class="c1">// peerSockets is an array of UDP sockets</span>
<span class="nx">cart</span><span class="p">.</span><span class="nx">run</span><span class="p">();</span>
<span class="nx">cart</span><span class="p">.</span><span class="nx">items</span> <span class="c1">// the cart's items</span>
</code></pre>
</div>

<p>Uh-oh. Can you spot the problem? Let’s break it down. In the original code, the current node’s cart items were <em>unioned</em> with the communicating node’s cart. Since there was no deletion, carts could only ever expand. Here was Jerry’s plan:</p>

<blockquote>
  <p>I want to delete things. If you delete something from node 1, and intersect it’s state from node 2, the item will be deleted from node 2 as well.</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">Node1: { A, B }
Node2: { A, B }

delete(Node2, A)

Node1: { A, B }
Node2: { B }

Node1 = Node1.intersect(Node2)
Node1: { B }
</code></pre>
</div>

<p>The reasoning may be sound. However, there’s a huge issue here. We’ve flipped the <code class="highlighter-rouge">union</code> operation on its head! Now, carts can <em>never</em> expand! They can only either stay the same size or shrink. So although Jerry’s contrived example works, it’s impossible to ever reach the beginning states of Node 1 and Node 2 unless those two nodes receive <em>the same writes</em>. Let’s take it from the top:</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">Node 1: { }
Node 2: { }

add(Node1, A)
add(Node2, B)

Node 1: { A }
Node 2: { B }

Node1_temp = Node1.intersect(Node2)
Node2_temp = Node2.intersect(Node1)
Node1 = Node1_temp
Node2 = Node2_temp

Node 1: { }
Node 2: { }
</code></pre>
</div>

<p>This is pretty nasty. Jerry has come along and with a few lines of code he’s obliterated our nice strong eventually consistent code. Surely there’s a better way.</p>

<h2 id="logical-monotonicity">Logical Monotonicity</h2>

<p>The original Javascript we wrote down exhibits the property from Section 6 known as logical <em>monotonicity</em>. The union operation ensures that a given node’s state is always “greater than or equal to” the states of the other nodes. However, how can we be <em>sure</em> that this property is maintained throughout the development of this program? As we’ve seen, there’s nothing stopping an intern from coming along, making a mindless change, and destroying this wonderful property. Ideally, we want to make it impossible (or at least very difficult) to write programs that violate this property. Or, at the very least, we want to make it very easy to write programs that maintain these types of properties.</p>

<p>But where should these guarantees live? In the above Javascript example, the guarantees aren’t guarantees at all, really. There’s no restriction on what the programmer is allowed to do - the programmer has simply constructed a program that mirrors guarantees that she has modeled in her brain. In order to maintain properties such as <em>monotonicity</em>, she must constantly check the model in her brain against the code. We haven’t really helped the programmer out that much - she has a lot of thinking to do.</p>

<p>Databases such as PostgreSQL have issues like this as well, though they handle them quite differently, masters may need to ensure that writes have occurred on every slave before the database becomes available for reading. A database system like this has pushed consistency concerns to the IO-level, completely out of the users control. They are enforced on system reads and system writes. This approach gives programmers no flexibility: as demonstrated with our shopping cart example, there’s no need for these type of restrictions; we can tolerate inconsistency in order to maintain availability.</p>

<p>Why not push the consistency guarantees in between the IO-level and the application-level? <a href="http://dist-prog-book.com/chapter/7/langs-consistency.html#ConsistencyWithoutBorders">(Alvaro, Bailis, Conway, &amp; Hellerstein, 2013)</a> Is there any reason why you as the programmer couldn’t program using tools that facilitate these types of monotonic programs? If you’re familiar with formal systems – why not construct a formal system (programming language / library) in which every theorem (program) is formally guaranteed to be monotonic? If it’s <em>impossible</em> to express a non-monotonic program, the programmer needn’t worry about maintaining a direct mapping between their code and his or her mental model.</p>

<p>Wouldn’t it be great if tools like this existed?</p>

<h2 id="bloom">Bloom</h2>

<p>Before talking about such tools, I’d like you to forget almost everything you know about programming for a second (unless of course you’ve never programmed in a Von Neumann-based language in which you sequentially update pieces of memory).</p>

<p>Imagine the following scenario: you are “programming” a node in a cluster of computers. All of the other computers work as expected. As a node in this cluser, when you receive a message (all messages will include an integer), your task is to save the message, increment the integer, and resend the new message with the incremented integer back to its originator. You must also send any new messages you’ve received from <code class="highlighter-rouge">stdin</code>. Unfortunately, the programming environment is a little strange.</p>

<p>You have access to five sets:</p>
<ul>
  <li>Messages you have received in the last 5 seconds (read)</li>
  <li>Inputs you’ve received from <code class="highlighter-rouge">stdin</code> in the last 5 seconds (read)</li>
  <li>An outgoing messages set: flushed &amp; sent every 5 seconds (write)</li>
  <li>A bucket of saved messages: <em>never</em> flushed (read/write)</li>
</ul>

<p>However, you’re only given access to these sets <em>every 5 seconds</em>. If messages are formatted as such: <code class="highlighter-rouge">(SOURCE, INTEGER, T)</code>, your sets might look like when <code class="highlighter-rouge">t = 0</code>. (<code class="highlighter-rouge">t</code> is the number of seconds elapsed)</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">&lt;T = 0&gt;
RECV-BUFFER: {(A, 1, 0), (B, 2, 0)}
RSTDIN-INPUTS: {(A, 5, 0), (C, 10, 0)}
SEND-BUFFER: {}
SAVED: {(D, -1, 0), (E, -100, 0)}
</code></pre>
</div>

<p>If you don’t write any code to manipulate these sets, when <code class="highlighter-rouge">t = 5</code>, your sets might look like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-">&lt;T = 5&gt;
RECV-BUFFER: {(C, 10, 5)}
STDIN-INPUTS: {(X, 1, 5)}
SEND-BUFFER: {}
SAVED: {(D, -1, 0), (E, -100, 0)}
</code></pre>
</div>

<p>You can see that from <code class="highlighter-rouge">t = 0</code> to <code class="highlighter-rouge">t = 5</code>, you received one message from <code class="highlighter-rouge">C</code> and someone typed a message to <code class="highlighter-rouge">X</code> via <code class="highlighter-rouge">stdin</code>.</p>

<p>Remember our goals?</p>
<ul>
  <li>Save received messages from the network</li>
  <li>Send out messages received from <code class="highlighter-rouge">stdin</code></li>
  <li>For all received network messages, increment the integer and resend it back to the originator</li>
</ul>

<p>In Javascript, perhaps you code up something like this:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="nx">onFiveSecondInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">recvBuffer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">savedBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>            <span class="c1">// save message</span>
    <span class="kd">let</span> <span class="nx">newMsg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="nx">newMsg</span><span class="p">.</span><span class="nx">integer</span><span class="o">++</span><span class="p">;</span>                 <span class="c1">// increment recv'd message</span>
    <span class="nx">newMsg</span><span class="p">.</span><span class="nx">flipSourceDestination</span><span class="p">()</span>
    <span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newMsg</span><span class="p">);</span>          <span class="c1">// send it out</span>
  <span class="p">});</span>

  <span class="nx">stdinInputBuffer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>             <span class="c1">// send stdin message</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>or Ruby:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="n">on_five_second_interval</span> <span class="k">do</span>
  <span class="n">recv_set</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
    <span class="n">saved_set</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span>
    <span class="n">new_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">clone</span>
    <span class="n">new_msg</span><span class="p">.</span><span class="nf">integer</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">new_msg</span><span class="p">.</span><span class="nf">flip_source_destination</span>
    <span class="n">send_set</span> <span class="o">&lt;&lt;</span> <span class="n">new_msg</span>
  <span class="k">end</span>

  <span class="n">stdin_input_set</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
    <span class="n">send_set</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>We have expressed this model using an event-driven programming style: the callbacks are triggered when <code class="highlighter-rouge">t % 5 = 0</code>: when the sets populate &amp; flush.</p>

<p>Notice we perform a few “copies”. We read something from one set and place it into another one, perhaps after applying some modification. Perhaps we place a message from a given set into two sets (<code class="highlighter-rouge">recv_set</code> to <code class="highlighter-rouge">saved_set</code> &amp; <code class="highlighter-rouge">send_set</code>).</p>

<p>This situation screams for a more functional approach:</p>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="n">on_five_second_interval</span> <span class="k">do</span>
  <span class="n">saved_set</span> <span class="o">+=</span> <span class="n">recv_set</span>             <span class="c1"># add everything in recv_set to saved_set</span>

  <span class="n">send_set</span> <span class="o">+=</span> <span class="n">recv_set</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="c1"># map over the recv_set, increment integers, add to send_set</span>
    <span class="n">new_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">clone</span>
    <span class="n">new_msg</span><span class="p">.</span><span class="nf">integer</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">new_msg</span><span class="p">.</span><span class="nf">flip_source_destination</span>       <span class="c1"># send to originator</span>
    <span class="n">new_msg</span>                               <span class="c1"># this block returns new_msg</span>
  <span class="k">end</span>

  <span class="n">send_set</span> <span class="o">+=</span> <span class="n">stdin_input_set</span>       <span class="c1"># add stdin messages to the send set</span>
<span class="k">end</span>
</code></pre>
</div>

<p>After this block/callback is called, the system automatically flushes &amp; routes messages as described above.</p>

<p>Bloom <a href="http://dist-prog-book.com/chapter/7/langs-consistency.html#Bloom">(Alvaro, Conway, Hellerstein, &amp; Marczak, 2011)</a>, a research language developed at UC Berkeley, has a similar programming model to the one described above. Execution is broken up into a series of “timesteps”. In the above example, one “timestemp” would be the execution of one <code class="highlighter-rouge">on_five_second_interval</code> function. Bloom, like the theoretical system above, automatically flushes and populates certain sets before and after each timestep. In the above example, 5 seconds was an arbitrary amount of time. In Bloom, timesteps (rounds of evaluation) are logical tools - they may happen every second, 10 seconds, etc. Logically, it shouldn’t affect how your program executes. In reality, Bud’s timesteps correspond to evaluation iterations. Your code is evaluated, executed, and the process repeats.</p>

<p>So what does a Bloom program look like? Bloom’s prototypal implementation is called Bud and is implemented in Ruby. There are two main parts to a Bloom program:</p>

<ol>
  <li>User defined sets: rather than the four sets I gave you above, Bloom users can define their own sets. There are different types of sets depending on the behavior you desire. Bloom refers to these sets as ‘collections’:
    <ul>
      <li><code class="highlighter-rouge">channel</code>: Above, <code class="highlighter-rouge">recv_set</code> and <code class="highlighter-rouge">send_set</code> would be considered channels. They facilitate sending network messages to and from other nodes. Like the messages above, messages sent into these channels contain a “location-specifier”, which tells Bloom where the message should be sent. If you wanted to send a message to <code class="highlighter-rouge">A</code>, you could push the message <code class="highlighter-rouge">(@A, 10)</code> into your send set (in Ruby, <code class="highlighter-rouge">["@A", 10]</code>). The <code class="highlighter-rouge">@</code> denotes the location-specifier. At the end of the timestep (or callback execution in the above example), these set are flushed.</li>
      <li><code class="highlighter-rouge">table</code>: Above, <code class="highlighter-rouge">saved_set</code> would be considered a table. The contents of tables persist across timesteps, which means tables are never flushed.</li>
    </ul>
  </li>
  <li>Code to be executed at each timestep. A Bloom (Bud) program can be seen as the inside of the block passed to <code class="highlighter-rouge">on_five_second_interval</code>. In fact, it looks very similar, as we’ll see.</li>
</ol>

<p>For the purposes of this chapter, let’s assume <code class="highlighter-rouge">stdin_input_set</code> is a special kind of channel in which are sent in via <code class="highlighter-rouge">stdin</code>. Let’s also assume this channel exists in all Bloom programs.</p>

<p>Let’s take a look at an example Bud program.</p>

<p>First, let’s declare our state.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="k">module</span> <span class="nn">Incrementer</span>
  <span class="k">def</span> <span class="nf">state</span>
    <span class="n">channel</span> <span class="ss">:network_channel</span> <span class="p">[</span><span class="s1">'@dst'</span><span class="p">,</span> <span class="s1">'src'</span><span class="p">,</span> <span class="s1">'integer'</span><span class="p">]</span>
    <span class="n">table</span> <span class="ss">:saved_set</span> <span class="p">[</span><span class="s1">'dst'</span><span class="p">,</span> <span class="s1">'src'</span><span class="p">,</span> <span class="s1">'integer'</span><span class="p">]</span>
    <span class="c1"># implied channel :stdin_input_set ['@dst', 'src', 'integer']</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The first line of <code class="highlighter-rouge">state</code> means: declare a channel called <code class="highlighter-rouge">network_channel</code> in which messages are 3-tuples. The first field of the message is called <code class="highlighter-rouge">dst</code>, the second <code class="highlighter-rouge">src</code>, and the third is called <code class="highlighter-rouge">integer</code>. <code class="highlighter-rouge">@</code> is our location-specifier, so if a program wants to send a message to a node at a given identifier, they will place it in the first <code class="highlighter-rouge">dst</code> field. For example, a message destined for <code class="highlighter-rouge">A</code> would look like <code class="highlighter-rouge">['A', 'me', 10]</code>. The <code class="highlighter-rouge">@</code> denotes the location-specifier within the collection’s “schema”.</p>

<p>The second line means: declare a table (persists) called <code class="highlighter-rouge">saved_set</code> in which messages follow the same format as <code class="highlighter-rouge">network_channel</code>. There’s no location specifier since this collection is not network-connected.</p>

<p>You can think of the Ruby array after the channel name as the “schema” of that collection.</p>

<p>Notice how we only have one network channel for both receiving and sending. Before, we had two sets, one for sending and one for receiving. When we place items <em>into</em> <code class="highlighter-rouge">network_channel</code>, Bud will automatically send messages to the appropriate <code class="highlighter-rouge">@dst</code>.</p>

<p>Next, let’s write our code. This code will be executed at every timestamp. In fact, you can think of a Bud program as the code inside of a timestamp callback. Let’s model the raw Ruby code we saw above.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="k">module</span> <span class="nn">Incrementer</span>
  <span class="k">def</span> <span class="nf">state</span>
    <span class="n">channel</span> <span class="ss">:network_channel</span> <span class="p">[</span><span class="s1">'@dst'</span><span class="p">,</span> <span class="s1">'src'</span><span class="p">,</span> <span class="s1">'integer'</span><span class="p">]</span>
    <span class="n">table</span> <span class="ss">:saved_set</span> <span class="p">[</span><span class="s1">'dst'</span><span class="p">,</span> <span class="s1">'src'</span><span class="p">,</span> <span class="s1">'integer'</span><span class="p">]</span>
    <span class="c1"># implied channel :stdin_input_set ['@dst', 'src', 'integer']</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">increment_messages</span>
    <span class="n">network_channel</span> <span class="o">&lt;~</span> <span class="n">network_channel</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">src</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nf">dst</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nf">integer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">save_messages</span>
    <span class="n">saved_set</span> <span class="o">&lt;=</span> <span class="n">network_channel</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">send_messages</span>
    <span class="n">network_channel</span> <span class="o">&lt;~</span> <span class="n">stdin_input_set</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Don’t panic. Remember - the output of this program is identical to our Ruby callback program from earlier. Let’s walk through it step by step.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="n">declare</span>
<span class="k">def</span> <span class="nf">increment_messages</span>
  <span class="n">network_channel</span> <span class="o">&lt;~</span> <span class="n">network_channel</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">src</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nf">dst</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="nf">integer</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here, we take messages we’ve received from the network channel and send them back into the network channel. The <code class="highlighter-rouge">&lt;~</code> operator says “copy all of the elements in the right-hand-side and eventually send them off onto the network in the channel on the left-hand-side”. So, we map over the contents of network channel <em>in the current timestep</em>: switching the <code class="highlighter-rouge">src</code> and <code class="highlighter-rouge">dst</code> fields, and incrementing the integer. This mapped collection is passed back into the network channel. Bud will ensure that those messages are sent off at some point.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="n">declare</span>
<span class="k">def</span> <span class="nf">save_messages</span>
  <span class="n">saved_set</span> <span class="o">&lt;=</span> <span class="n">network_channel</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">save_messages</code>, we use the <code class="highlighter-rouge">&lt;=</code> operator. <code class="highlighter-rouge">&lt;=</code> says “copy all of the elements in the right-hand-side and add them to the table on the left-hand-side.” It’s important to note that this movement occurs <em>within the current timestep</em>. This means if <code class="highlighter-rouge">saved_set</code> is referenced elsewhere in the code, it will include the contents of <code class="highlighter-rouge">network_channel</code>. If we had used the <code class="highlighter-rouge">&lt;+</code> operator instead, the contents of <code class="highlighter-rouge">network_channel</code> would show up in <code class="highlighter-rouge">saved_set</code> in the <em>next</em> timestep. The latter is useful if you’d like to operate on the current contents of <code class="highlighter-rouge">saved_set</code> in the current timestep but want to specify how <code class="highlighter-rouge">saved_set</code> should be updated for the next timestep.</p>

<p>Remember, all of this code is executed in <em>each</em> timestep - the separation of code into separate methods is merely for readability.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="n">declare</span>
<span class="k">def</span> <span class="nf">send_messages</span>
  <span class="n">network_channel</span> <span class="o">&lt;~</span> <span class="n">stdin_input_set</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">send_messages</code> operates very much like <code class="highlighter-rouge">increment_messages</code>, except it reads the contents of <code class="highlighter-rouge">stdin_input_set</code> and places them into the network channel to be sent off at an indeterminite time.</p>

<h3 id="details">Details</h3>

<p>Examine Bloom’s “style”. Compare it to your standard way of programming. Compare it to the Javascript &amp; Ruby timestep/callback examples. Bloom has a more “declarative” style: what does this mean? Look at our Javascript:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="nx">onFiveSecondInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">recvBuffer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">savedBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>            <span class="c1">// save message</span>
    <span class="kd">let</span> <span class="nx">newMsg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
    <span class="nx">newMsg</span><span class="p">.</span><span class="nx">integer</span><span class="o">++</span><span class="p">;</span>                 <span class="c1">// increment recv'd message</span>
    <span class="nx">newMsg</span><span class="p">.</span><span class="nx">flipSourceDestination</span><span class="p">();</span>
    <span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newMsg</span><span class="p">);</span>          <span class="c1">// send it out</span>
  <span class="p">});</span>

  <span class="nx">stdinInputBuffer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>             <span class="c1">// send stdin message</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>“Every five seconds, loop over the received messages. For each message, do this, then that, then that.” We are telling the computer each step we’d like it to perform. In Bud, however, we describe the state of tables and channels at either the current or next timestep using operators and other tables and channels. We describe what we’d like our collections to include and look like, rather than what to do. You declare what you’d like the state of the world to be at the current instant and at following instants.</p>

<h3 id="isnt-this-chapter-about-consistency">Isn’t this chapter about consistency?</h3>

<p>It’s time to implement our shopping cart in Bloom. We are going to introduce one more collection: a <code class="highlighter-rouge">periodic</code>. For example, <code class="highlighter-rouge">periodic :timer 10</code> instantiates a new periodic collection. This collection becomes “populated” every 10 seconds. Alone, it’s not all that useful. However, when <code class="highlighter-rouge">join</code>‘d with another table, it can be used to perform actions every <code class="highlighter-rouge">x</code> seconds.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="k">module</span> <span class="nn">ShoppingCart</span>
  <span class="kp">include</span> <span class="no">MulticastProtocol</span>

  <span class="k">def</span> <span class="nf">state</span>
    <span class="n">table</span> <span class="ss">:cart</span> <span class="p">[</span><span class="s1">'item'</span><span class="p">]</span>
    <span class="n">channel</span> <span class="ss">:recv_channel</span> <span class="p">[</span><span class="s1">'@src'</span><span class="p">,</span> <span class="s1">'dst'</span><span class="p">,</span> <span class="s1">'item'</span><span class="p">]</span>
    <span class="c1"># implied channel :stdin_input_set ['item']</span>
    <span class="n">periodic</span> <span class="ss">:timer</span> <span class="mi">10</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">add_items</span>
    <span class="n">cart</span> <span class="o">&lt;=</span> <span class="n">stdin_input_set</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">send_items</span>
    <span class="n">send_mcast</span> <span class="o">&lt;=</span> <span class="n">join</span><span class="p">([</span><span class="n">cart</span><span class="p">,</span> <span class="n">timer</span><span class="p">]).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="n">timer</span><span class="o">|</span> <span class="n">item</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">declare</span>
  <span class="k">def</span> <span class="nf">receive_items</span>
    <span class="n">cart</span> <span class="o">&lt;+</span> <span class="n">recv_channel</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">item</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">send_mcast</code> is a special type of channel we receive from the <code class="highlighter-rouge">MulticastProtocol</code> mixin. It sends all items in the right-hand-side to every known peer.</p>
<ul>
  <li><code class="highlighter-rouge">add_items</code>: receive items from stdin, add them to the cart</li>
  <li><code class="highlighter-rouge">send_items</code>: join our cart with the 10-second timer. Since the timer only “appears” every 10 seconds, this <code class="highlighter-rouge">join</code> will produce a result every 10 seconds. When it does, send all cart items to all peers via <code class="highlighter-rouge">send_mcast</code>.</li>
  <li><code class="highlighter-rouge">receive_items</code>: when we receive a message from a peer, add the item to our cart.</li>
</ul>

<p>Functionally, this code is equivalent to our working Javascript shopping cart implementation. However, there are a few important things to note:</p>
<ul>
  <li>In our Javascript example, we broadcasted our entire cart to all peers. When a peer received a message, they unioned their current cart with the received one. Here, each node broadcasts each element in the cart. When a node receives an item, it adds it to the current cart. Since tables are represented as sets, repeated or unordered additions do not matter. You can think of <code class="highlighter-rouge"><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B,</span><span class="w"> </span><span class="err">C</span><span class="p">}</span><span class="err">.add(D)</span></code> as equivalent to <code class="highlighter-rouge"><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B,</span><span class="w"> </span><span class="err">C</span><span class="p">}</span><span class="err">.union(</span><span class="p">{</span><span class="err">D</span><span class="p">}</span><span class="err">)</span></code>.</li>
  <li>You cannot add items twice. Since tables are represented as sets and we simply add items to our set, an item can only ever exist once. This was true of our Javascript example as well.</li>
  <li>You still cannot remove items!</li>
</ul>

<p>Bloom has leveraged the montononic, add-only set and constructed a declarative programming model based around these sets. When you treat everything as sets (not unlike SQL) and you introduce the notion of “timestemps”, you can express programs as descriptions of state rather than an order of operations. Besides being a rather unique model, Bloom presents an accessible and (perhaps…) safe model for programming eventually consistent programs.</p>

<h3 id="sets-only">Sets only?</h3>

<p>Bloom’s programming model is built around the set. As Aviral discussed in the previous chapter, however, sets are not the only monotonic data structures. Other CRDTs are incredibly useful for programming eventually consistent distributed programs.</p>

<p>Recall that a <em>bounded join semilattice</em> (CRDT) can be represented as a 3-tuple: <code class="highlighter-rouge">(S, U, ⊥)</code>. <code class="highlighter-rouge">S</code> is the set of all elements within the semilattice. <code class="highlighter-rouge">U</code> is the <code class="highlighter-rouge">least-upper bound</code> operation. <code class="highlighter-rouge">⊥</code> is the “least” element within the set. For example, for add-only sets, <code class="highlighter-rouge">S = the set of all sets</code>, <code class="highlighter-rouge">U = union</code> and <code class="highlighter-rouge">⊥ = {}</code>. Elements of these semilattices, when <code class="highlighter-rouge">U</code> is applied, can only “stay the same or get larger”. Sets can only stay the same size or get larger - they can never rollback. For some element <code class="highlighter-rouge">e</code> in <code class="highlighter-rouge">S</code>, <code class="highlighter-rouge">e U ⊥</code> must equal <code class="highlighter-rouge">e</code>.
For a semilattice we’ll call <code class="highlighter-rouge">integerMax</code>, <code class="highlighter-rouge">S = the set of all integers</code>, <code class="highlighter-rouge">U = max(x, y)</code>, and <code class="highlighter-rouge">⊥ = -Infinity</code>. Hopefully you can see that elements of this lattice (integers) “merged” with other elements of this lattice never produce a result less than either of the merged elements.</p>

<p>These semilattices (and many more!) can be used to program other types of distributed, eventually consistent programs. Although sets are powerful, there might be more expressive ways to describe your program. It’s not difficult to imagine using <code class="highlighter-rouge">integerMax</code> to keep a global counter across multiple machines.</p>

<p>Unfortunately, Bloom does not provide support for other CRDTs. In fact, you cannot define your own datatypes at all. You are bound by the collections described.</p>

<p>Bloom<sup>L</sup> <a href="http://dist-prog-book.com/chapter/7/langs-consistency.html#BloomL">(Conway, Marczak, Alvaro, Hellersteina, &amp; Maier, 2012)</a>, an addendum to the Bloom language, provides support for these types of data structures. Specifically, Bloom<sup>L</sup> does two things:</p>
<ul>
  <li>Adds a number of built-in lattices such as <code class="highlighter-rouge">lmax</code> (<code class="highlighter-rouge">integerMax</code>), <code class="highlighter-rouge">lmin</code>, etc.</li>
  <li>Adds an “interface” for lattices: the user can define lattices that “implement” this interface.</li>
</ul>

<p>This interface, if in an OO language like Java, would look something like:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code class="prettyprint lang-"><span class="kd">interface</span> <span class="nc">Lattice</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="n">Lattice</span> <span class="nf">leastElement</span><span class="o">();</span>
  <span class="n">Lattice</span> <span class="nf">merge</span><span class="o">(</span><span class="n">Lattice</span> <span class="n">a</span><span class="o">,</span> <span class="n">Lattice</span> <span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Heather: [I am purposely leaving out morphisms &amp; monotones for the sake of simplicity.]</p>

<p>This provides the user with much more freedom in terms of the types of Bloom programs she can write.</p>

<h3 id="review">Review</h3>

<p>Bloom aims to provide a new model for writing distributed programs. And since bloom only allows for monotonic data structures with monotonicity-preserving operations, we’re safe from Jerry the intern, right?</p>

<p>Wrong. Unfortunately, I left out an operator from Bloom’s set of collection operators. <code class="highlighter-rouge">&lt;-</code> removes all elements in the right-hand-size from the table in the left-hand-side. So Bloom’s sets are <em>not</em> add-only. As we’ve seen from Jerry’s work on our original Javascript shopping cart implementation, naively attempting to remove elements from a distributed set is not a safe operation. Rollbacks can potentially destroy the properties we worked so hard to achieve. So what gives? Why would the Bloom developers add this operation?</p>

<p>Despite putting so much emphasis on consistency via logical monotonicity, the Bloom programmers recognize that your program might need <em>some</em> coordination.</p>

<p>In our example, we don’t require coordination. We accept the fact that a user may ask a given node for the current state of her shopping cart and may not receive the most up-to-date response. There’s no need for coordination, because we’ve used our domain knowledge to accept a compromise.</p>

<p>For our shopping cart examples: when a client asks a given node what’s in her cart, that node will respond with the information it’s received so far. We know this information won’t be <em>incorrect</em>, but this data could be <em>stale</em>. That client might be missing information.</p>

<p>The Bloom team calls points like the one above, the user asking to checkout the contents at the cart of a given node, <em>points of order</em>. These are points in your program where coordination may be required - depending on when and who you ask, you may receive a different response. In fact, the Bloom developers provide analysis tools for identifying points of order within your program. There’s no reason why you couldn’t implement a non-monotonic shopping cart in which all nodes must synchronize before giving a response to the user. The Bloom analysis tool would tell you where the points of order lie in your program, and you as the programmer could decide whether or not (and how!) to add coordination.</p>

<p>So what does Bloom really give us? First off, it demonstrates an unusual and possibly more expressive way to program distributed systems. Consistency-wise, it uses sets under the hood for its collections. As long as you shy away from <code class="highlighter-rouge">&lt;-</code> operator, you can be confident that your collections will only monotonically grow. Since the order of packets is not guaranteed, structuring these eventually consistent applications is reasonably easy within Bloom. Bloom<sup>L</sup> also gives us the power to define our own monotonic data structures by “implementing” the lattice interface.</p>

<p>However, Bloom makes it easy to program non-monotonic distributed programs as well. Applications may require coordination and the <code class="highlighter-rouge">&lt;-</code> operator in particular can cause serious harm to our desired formal properties. Luckily, Bloom attempts to let the programmer know exactly when coordination may be required within their programs. Whenever an operation may return a stale or non-up-to-date value, Bloom’s analysis tools let the programmer know.</p>

<p>Another thing to consider: Bloom<sup>L</sup>’s user-defined lattices are just that - user-defined. It’s up to the programmer to ensure that the data structures that implement the lattice interface are actually valid lattice structures. If your structures don’t follow the rules, your program will behave in some seemingly strange ways.</p>

<p>Currently Bloom exists as a Ruby prototype: Bud. Hypothetically speaking, there’s nothing stopping the programmer from writing normal, sequentially evaluated Ruby code within Bud. This can also cause harm to our formal properties.</p>

<p>All in all, Bloom provides programmers with a new model for writing distributed programs. If the user desires monotonic data structures and operations, it’s relatively easy to use and reason about. Rather than blindly destroying the properties of your system, you will know exactly when you introduce a possible point of order into your program. It’s up to you to decide whether or not you need to introduce coordination.</p>

<h2 id="lasp">Lasp</h2>

<p>Lasp <a href="http://dist-prog-book.com/chapter/7/langs-consistency.html#Lasp">(Meiklejohn &amp; Roy, 2015)</a> is an Erlang library which aims to facilitate this type of “disorderly” programming.</p>

<p>Lasp provides access to myriad of CRDTs. The programmer can have confidence that the CRDTs obey the lattice formal requirements. Like Bloom<sup>L</sup>, if the user desires a new lattice he or she may implement it using an interface.</p>

<p>A Simple Lasp Program is defined as either a:</p>

<ul>
  <li>Single CRDT instance</li>
  <li>A “Lasp process” with <em>m</em> inputs, all Simple Lasp Programs, and one output CRDT instance</li>
</ul>

<p>For those of you unfamiliar with Erlang: a <em>process</em> can be thought of as an independent piece of code executing asynchronously. Processes in Erlang are actors that act sequentially and exchange messages through asynchronous message passing.</p>

<p>Programming in Erlang is unique in comparison to programming in Ruby or Javascript. Erlang processes are spun off for just about everything - and they are independent actors of code acting independently while communicating with other processes. Naturally, distributed systems programming fits well here. Processes can be distributed within a single computer or distributed across a cluster of computers. So communication between processes may move over the network.</p>

<p>Distribution of a data structure, then, means the transmission of a data structure across network-distributed processes. If a client asks for the state of the shopping cart in Beijing, the processes located on the computer in Beijing will respond. However, the processes in New York may disagree. Thus, our task is to distribute our data structures (CRDTs, right?) across distributed processes.</p>

<p>So, what’s a “Lasp process”? A Lasp process is a process that operates on lattice elements, or CRDTs. Three popular Lasp processes are <code class="highlighter-rouge">map</code>, <code class="highlighter-rouge">fold</code>, and <code class="highlighter-rouge">filter</code>.</p>

<ul>
  <li><code class="highlighter-rouge">map</code>: If you’re familiar with functional programming, these functions shouldn’t appear too foreign. <code class="highlighter-rouge">map</code> spins off a never-ending process which applies a user-supplied <code class="highlighter-rouge">f</code> to all the replicas of a given CRDT this processes receives.</li>
  <li><code class="highlighter-rouge">fold</code>: Spins off a process that continously folds input CRDT values into another CRDT value using a user-provided function.</li>
  <li><code class="highlighter-rouge">filter</code>: Spins off a process that continously picks specific CRDT input values based on a user-provided filtering function.</li>
</ul>

<p>Drawing parallels to our mock-Bloom-Ruby-callback implementation, we remember that CRDT modifications and movements can be modeled using functional styles. In Bloom, we dealt with mapping values from “collections” to other “collections”. These collections were backed by CRDT-like sets.</p>

<p>Here, we are mapping “streams” of CRDT instances to other CRDT instances using the same functional programming methods.</p>

<p>However, here, the stream manipulations occcur within unique processes distributed across a network of computers. These processes consume CRDTs and produce new ones based on functions provided by the user.</p>

<p>There’s one hiccup though: the user can’t provide <em>any</em> function to these processes. Since our datatypes must obey certain properties, the functions that operate on our datas must preserve these properties.</p>

<p>Recall that within a lattice, a partial order exists. One element is always <code class="highlighter-rouge">&lt;=</code> another element. For example, with add-only sets, <code class="highlighter-rouge"><span class="p">{</span><span class="err">A</span><span class="p">}</span><span class="w"> </span><span class="err">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="err">A</span><span class="p">}</span><span class="w"> </span><span class="err">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B</span><span class="p">}</span><span class="w"> </span><span class="err">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B</span><span class="p">}</span><span class="w"> </span><span class="err">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B,</span><span class="w"> </span><span class="err">C</span><span class="p">}</span></code>. A <em>monotonic</em> function that operates over the domain of add-only sets must preserve this partial ordering. For example - if <code class="highlighter-rouge"><span class="p">{</span><span class="err">A</span><span class="p">}</span><span class="w"> </span><span class="err">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="err">A,</span><span class="w"> </span><span class="err">B</span><span class="p">}</span></code> and <code class="highlighter-rouge">f</code> is a monotonic function that operates over add-only sets, <code class="highlighter-rouge">f({A}) &lt;= f({A, B})</code>.</p>

<p>This ensures the preservation of our consistency properties across our ever-interacting processes.</p>

<h3 id="a-library">A Library</h3>

<p>Remember that Lasp is an Erlang <em>library</em>. Within your existing Erlang program, you’re free to drop in some interacting Lasp-processes. These processes will communicate using CRDTs and functions over CRDTs. As such, your Lasp sub-program is guaranteed to exhibit strong eventual consistency properties.</p>

<p>However, the rest of your Erlang program is not. Since Lasp is embeddable, it has no control over the rest of your Erlang program. You must be sure to use Lasp in a safe way. But since it doesn’t provide the programmer with the ability to perform non-monotonic operations within the Lasp-context, the programmer can have significant confidence in the eventual consistency of the Lasp portion of the program. We still aren’t totally safe from Jerry the intern, since Jerry can modify our outer-Erlang to do some dangerous things.</p>

<p>Bloom provided a new model for distributed programming, where Lasp aims to provide existing distributed systems with a drop-in solution for adding eventually consistent parts to their systems.</p>

<h2 id="consistency-languages-utilization">Consistency Languages: Utilization</h2>

<p>Compare Lasp and Bloom:</p>

<p>Lasp</p>
<ul>
  <li>An Erlang library, meant to be used in every-day Erlang programs.</li>
  <li>Built-in CRDTs.</li>
  <li>All data structures are CRDTs and all operations are logically monotonic.</li>
  <li>Thus, it’s essentially impossible to construct a non-monotonic program <em>using only the Lasp library</em>.</li>
  <li>It is possible to use Lasp in a non-monotonic way with disrupting outer Erlang code.</li>
  <li>Follows well-known functional programming patterns and is compatible with optimal Erlang style.</li>
</ul>

<p>Bloom:</p>
<ul>
  <li>Aims to be a full-featured language. Is not meant to be embeddable.</li>
  <li>Built-in set collections only. Allows user-defined CRDTs.</li>
  <li>Its sets are not add-only and thus not exclusively logically monotonic. User-defined lattices carry no formal proofs of their consistency gaurantees.</li>
  <li>It’s possible to construct non-monotonic programs. Using the <code class="highlighter-rouge">&lt;-</code> operator, for example.</li>
  <li>With the prototype, Bud, it’s possible to use normal Ruby code to disrupt Bloom’s properties. But this is more a result of the prototype implementation, not the design.</li>
  <li>Uses a unique programming model based on temporal logic.</li>
  <li>Contains an analysis tool that tells programmers which points in their code might require coordination, depending on the consistency concerns of the application.</li>
</ul>

<p>Although they are fundamentally different in many ways, Lasp and Bloom accept a key reality: it’s probably impossible to program using eventual consistency gaurantees only. It works for shopping carts, but there will always be situations where coordination between machines will need to occur. Lasp and Bloom’s designs reflect the different approaches for dealing with this harsh truth.</p>

<p>Lasp, on one hand, plans to be an embeddable eventually-consistent library. If you’re an Erlang developer and you recognized a situation in which you can accept eventual consistent properties, you can reach for the Lasp library. Within your existing code, you can add communication mechanisms using Lasp and be confident of the properties advertised by eventual consistent systems. No need to change your entire system or re-write code in a different language. Since Lasp does not allow the expression of non-monotonic programs, you express non-monotonicity <em>outside</em> of the Lasp sections in your code.</p>

<p>Bloom, on the other hand, aims to be an entirely new model for expressing distributed systems problems. By using CRDT-like sets for their collections, they can encourage a declarative way of programming without enforcing too much coordination. They even let the user define their own lattices with Bloom<sup>L</sup> to further encourage this type of programming. But since there will always be times where coordination is necessary, Bloom allows for operations that may require coordination. They even allow the user to perform non-monotonic operations such as <code class="highlighter-rouge">&lt;-</code>. Bloom, in a way, must do this. They must provide the user with mechanisms for coordination, since they aim to create a new model for expressing distributed systems programs. Lasp is embeddable, so it can perform one specific job. Bloom is not, so it must allow many types of programs. In order to ameliorate this, Bloom provides the programmer with anaylsis tools to help the programmer identify points in the code that may not be totally safe. The programmer can then decide to coordinate or ignore these “points of order”.</p>

<p>Most programming languages are “general-use”. This works for single machine programming. As the world moves toward distributed programming, programmers must adopt models / languages / libraries that are built for their domain. It forces serious thought on the part of the programmer: what <em>exactly</em> am I trying to achieve, and what am I willing to sacrifice?</p>

<p>Bloom could potentially facilitate distributed systems programming through a new, temporal model. The Bloom developers have designed a language for a specific purpose: distributed programming. The Lasp developers take this philosophy even further: let’s design a library for a specific subset of distributed systems programming. Although one goes deeper than the other, the two languages share an idea: languages / models should be build for subsets of the computing domain. Distributed systems produce difficult problems. When we put our heads together and develop tools to facilitate distributed systems programming (Bloom) and always <em>eventually consistent</em> distributed systems programming, programming gets easier. Fewer bugs pop up, and it becomes easier to formally reason about the behavior of our programs.</p>

<p>When a language or model tries to do everything well, it cannot provide formal guarantees or tools to facilitate certain problem solving. Since different domains have totally different needs and issues to deal with, general purpose programming languages simply try to provide the minimum required for a wide variety software problems.</p>

<p>If we shift our mindset as software developers and begin to develop and look for tools to help us with specific problems and domains of problems, we can leverage computers much more than we do today. Our tools can provide relevant feedback and help us design our systems. They can even provide formal properties that we need not question.</p>

<p>Critically, it requires a narrowing of our problem domain. It means inspecting our problem and asking what we need, and what’s not so important?</p>

<p>In this chapter, we examined ways in which tools can help us leverage eventually consistent distributed systems. But there’s no reason why this philosophy couldn’t be applied to other subsections of the CAP pyramid. In fact, there’s no reason why this philosophy couldn’t be applied to other areas of computing in general. Why are both video games and distributed systems programmed using the same language &amp; models?</p>

<p>Even if you don’t encounter consistency issues in your day-to-day life, this idea applies to many areas of computing and tools in general. Hopefully you can begin to ask yourself and those around you: what tasks are we trying to accomplish, and how can our tools help us accomplish them?</p>

<h2 id="references">References</h2>

<ol class="bibliography"><li><span id="BloomL">Conway, N., Marczak, W., Alvaro, P., Hellersteina, J. M., &amp; Maier, D. (2012). Logic and Lattices for Distributed Programming. <i>UC Berkeley Technical Report No. UCB/EECS-2012-167</i>, <i>167</i>. Retrieved from http://db.cs.berkeley.edu/papers/UCB-lattice-tr.pdf</span></li>
<li><span id="Bloom">Alvaro, P., Conway, N., Hellerstein, J. M., &amp; Marczak, W. R. (2011). Consistency Analysis in Bloom: a CALM and Collected Approach. In <i>Conference on Innovative Data Systems Research</i>. Retrieved from http://db.cs.berkeley.edu/papers/cidr11-bloom.pdf</span></li>
<li><span id="Lasp">Meiklejohn, C., &amp; Roy, P. V. (2015). Lasp: A Language for Distributed, Coordination-Free Programming. In <i>Proceedings of the 17th International Symposium on Principles and Practice of Declarative Programming</i>. Retrieved from https://pdfs.semanticscholar.org/c0ad/b28526a29f0765669167d3201e2b3605895e.pdf</span></li>
<li><span id="Dynamo">DeCandia, G., Hastorun, D., Jampani, M., Kakulapati, G., Lakshman, A., Pilchin, A., … Vogels, W. (2007). Dynamo: Amazon’s Highly Available Key-value Store. In <i>ACM Symposium on Operating Systems Principles</i>. Retrieved from https://s3.amazonaws.com/AllThingsDistributed/sosp/amazon-dynamo-sosp2007.pdf</span></li>
<li><span id="ConsistencyWithoutBorders">Alvaro, P., Bailis, P., Conway, N., &amp; Hellerstein, J. M. (2013). Consistency Without Borders. In <i>ACM Symposium on Cloud Computing</i>. Retrieved from http://www.bailis.org/papers/consistency-socc2013.pdf</span></li></ol>


<!-- </article> -->

      </div>
      <div class="col-sm-3">
        <nav id="toc" class="hidden-print hidden-xs affix" data-spy="affix" data-toggle="toc"><div class="toc-header affix" data-spy="affix"><span class="toc-contents">Contents</span></div><span class="toc-hide">Hide</span><span class="toc-expand">Expand</span></nav>
      </div>
      <div class="col-sm-1"></div>
    </div>
    <div class="row">
      <div class="col-sm-2"></div>
      <div class="col-sm-6">
        <div class="footer-links">
          
          
          
        </div>
      </div>
      <div class="col-sm-4"></div>
    </div>
  </div>

  <script>

      $( ".toc-hide" ).click(function() {
        // $( this ).toggleClass( "gray-bg" );
        $(".toc-contents").toggleClass( "lighter" );

        if ($(this).text() == 'Hide') {
          $(this).text("Show");
        } else {
          $(this).text("Hide");
        }
        // toggle visibility of contents, and expand button
        $(".nav").toggle();
        $(".toc-expand").toggle();
      });

      $( ".toc-expand" ).click(function() {
        // $( this ).toggleClass( "gray-bg" );

        if ($(this).text() == 'Expand') {
          $(this).text("Compact");
          $(".nav").css('display', 'block');
        } else {
          $(this).text("Expand");
          $(".nav .nav").css('display', 'none');
        }
      });

      // get current year and put it in span
      var currYear = new Date().getFullYear()
      $(".current-year").text(currYear);
  </script>




</body></html>